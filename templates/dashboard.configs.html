{% extends "dashboard.layout.html" %}

{% block stylesheets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/configs.css') }}">
{% endblock %}

{% block content %}
<div class="content-card">
  <div class="flex md:items-center justify-between mb-6 flex-col space-y-3 md:flex-row md:space-y-0">
    <div>
      <h1 class="content-title mb-0">Configs</h1>
      <p class="content-subtitle mb-0">Manage dynamic PAC configurations and priorities</p>
    </div>
    <a href="/dashboard/configs/new" class="btn btn-sm">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      New Config
    </a>
  </div>

  {% if message %}
  <div class="alert alert-success">{{ message }}</div>
  {% endif %}

  {% if errors %}
  <div class="alert alert-error">
    <ul class="alert-list">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="configs-list" id="configsList">
    {% for c in configs %}
    <div class="config-card" data-config-id="{{ c.id }}">
      <div class="config-drag-handle">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
        </svg>
      </div>
      <div class="config-info">
        <div class="config-priority">
          <span class="priority-badge">#{{ c.priority }}</span>
        </div>
        <div class="config-details">
          <div class="config-header">
            <div class="config-name">
              {{ c.name }}
              <span class="config-mode-badge config-mode-{{ c.mode.lower() }}">{{ c.mode_display }}</span>
            </div>
          </div>
          <div class="config-meta">
            {% if c.description %}
            <span class="config-description">{{ c.description }}</span>
            {% endif %}
            {% if c.use_builtin_proxy %}
            <span class="config-meta-separator">•</span>
            <span class="config-builtin-badge">Built-in Proxy</span>
            {% endif %}
            {% if c.ip_filter %}
            <span class="config-meta-separator">•</span>
            <span class="config-ip-filter">IP: {{ c.ip_filter }}</span>
            {% endif %}
            <span class="config-meta-separator">•</span>
            <span class="config-devices">{{ c.devices|length }} device(s)</span>
            <span class="config-meta-separator">•</span>
            <span class="config-created">Created <span class="ts" data-timestamp="{{ c.created_at.isoformat() }}" data-format="date">{{ c.created_at.strftime('%b %d, %Y') }}</span></span>
          </div>
        </div>
      </div>
      <div class="config-actions">
        <div class="toggle-container">
            <label class="toggle-switch" title="{% if c.is_active %}Disable{% else %}Enable{% endif %} config">
            <input type="checkbox" class="config-toggle" data-config-id="{{ c.id }}" {% if c.is_active %}checked{% endif %}>
            <span class="toggle-slider"></span>
            </label>
        </div>
        <a href="/dashboard/configs/{{ c.id }}" class="action-btn edit-btn">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <span>Edit</span>
        </a>
        <button class="action-btn delete-btn" data-config-id="{{ c.id }}">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          <span>Delete</span>
        </button>
      </div>
    </div>
    {% endfor %}

    {% if not configs %}
    <div class="empty-state">
      <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <h3 class="empty-state-title">No configurations yet</h3>
      <p class="empty-state-text">Create your first proxy configuration to get started</p>
      <a href="/dashboard/configs/new" class="btn btn-sm">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Create Config
      </a>
    </div>
    {% endif %}
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h2 class="modal-title">Confirm Deletion</h2>
      <button class="modal-close" id="closeDeleteModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="text-text-secondary">Are you sure you want to delete this config? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelDeleteModal">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<script src="{{ url_for('static', path='/js/lib/sortable.js') }}"></script>

<script>
  let currentConfigId = null;

  const configsList = document.getElementById('configsList');
  if (configsList) {
    const sortable = Sortable.create(configsList, {
      handle: '.config-drag-handle',
      animation: 150,
      ghostClass: 'config-card-ghost',
      onEnd: async function(evt) {
        const configId = evt.item.dataset.configId;
        const newIndex = evt.newIndex + 1; // 1-based priority

        try {
          const formData = new FormData();
          formData.append('priority', newIndex);

          const response = await fetch(`/dashboard/configs/${configId}/priority`, {
            method: 'POST',
            body: formData,
          });

          if (response.ok) {
            window.location.reload();
          }
        } catch (error) {
          console.error('Error updating priority:', error);
          evt.item.style.order = evt.oldIndex;
        }
      }
    });
  }

  document.querySelectorAll('.config-toggle').forEach(toggle => {
    toggle.addEventListener('change', async (e) => {
      const configId = toggle.dataset.configId;
      const isActive = toggle.checked;

      try {
        const formData = new FormData();
        formData.append('is_active', isActive);

        const response = await fetch(`/dashboard/configs/${configId}/toggle`, {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          toggle.checked = !isActive;
        }
      } catch (error) {
        console.error('Error toggling config:', error);
        toggle.checked = !isActive;
      }
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentConfigId = btn.dataset.configId;
      document.getElementById('deleteModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });

  function closeModal() {
    document.getElementById('deleteModal').classList.remove('active');
    document.body.style.overflow = '';
    currentConfigId = null;
  }

  document.getElementById('closeDeleteModal')?.addEventListener('click', closeModal);
  document.getElementById('cancelDeleteModal')?.addEventListener('click', closeModal);

  document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
    if (!currentConfigId) return;
    
    try {
      const response = await fetch(`/dashboard/configs/${currentConfigId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        window.location.reload();
      }
    } catch (error) {
      console.error('Error deleting config:', error);
    }
  });
</script>
{% endblock %}
