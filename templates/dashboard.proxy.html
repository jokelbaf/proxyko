{% extends "dashboard.layout.html" %}

{% block stylesheets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/proxy.css') }}">
{% endblock %}

{% block content %}
<div class="proxy-page-container">
  <div class="content-card">
    <div class="proxy-representation {% if not proxy_enabled %}proxy-disabled{% elif not is_proxy_healthy %}proxy-disconnected{% endif %}">
      <div class="proxy-background">
        <div class="traffic-lines">
          <div class="traffic-line" style="animation-delay: 0s;"></div>
          <div class="traffic-line" style="animation-delay: 0.5s;"></div>
          <div class="traffic-line" style="animation-delay: 1s;"></div>
          <div class="traffic-line" style="animation-delay: 1.5s;"></div>
          <div class="traffic-line" style="animation-delay: 2s;"></div>
          <div class="traffic-line" style="animation-delay: 2.5s;"></div>
        </div>
      </div>
      
      <div class="proxy-content">
        <div class="proxy-icon-container">
          <div class="proxy-glow"></div>
          <svg class="proxy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="2" y="2" width="20" height="8" rx="1" stroke-width="1.5"/>
            <rect x="2" y="14" width="20" height="8" rx="1" stroke-width="1.5"/>
            <circle cx="5" cy="6" r="1" fill="currentColor"/>
            <circle cx="5" cy="18" r="1" fill="currentColor"/>
            <line x1="8" y1="6" x2="11" y2="6" stroke-width="1.5" stroke-linecap="round"/>
            <line x1="8" y1="18" x2="11" y2="18" stroke-width="1.5" stroke-linecap="round"/>
            <line x1="14" y1="6" x2="19" y2="6" stroke-width="1.5" stroke-linecap="round"/>
            <line x1="14" y1="18" x2="19" y2="18" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M12 10.5 L12 13.5" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M10.5 12 L13.5 12" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>

        <div class="proxy-status-info">
          <h2 class="proxy-status-title">Proxy Server</h2>
          <div class="proxy-status-badge">
            <span class="status-dot"></span>
            <span class="status-text">
              {% if not is_proxy_healthy %}Not Connected{% elif not proxy_enabled %}Disabled{% else %}Active{% endif %}
            </span>
          </div>
        </div>

        <div class="proxy-toggle-container">
          <label class="proxy-toggle-switch" title="{% if proxy_enabled %}Disable{% else %}Enable{% endif %} proxy">
            <input type="checkbox" id="proxyToggle" {% if proxy_enabled %}checked{% endif %}>
            <span class="proxy-toggle-slider">
              <span class="toggle-label toggle-label-off">OFF</span>
              <span class="toggle-label toggle-label-on">ON</span>
            </span>
          </label>
        </div>
      </div>
    </div>
  </div>

<div class="content-card">
  <div class="flex md:items-center justify-between mb-6 flex-col space-y-3 md:flex-row md:space-y-0">
    <div>
      <h1 class="content-title mb-0">Proxy Rules</h1>
      <p class="content-subtitle mb-0">Manage proxy forwarding rules and routing</p>
    </div>
    <a href="/dashboard/proxy/rule/new" class="btn btn-sm">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      New Rule
    </a>
  </div>

  {% if message %}
  <div class="alert alert-success">{{ message }}</div>
  {% endif %}

  {% if errors %}
  <div class="alert alert-error">
    <ul class="alert-list">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="rules-list" id="rulesList">
    {% for rule in rules %}
    <div class="rule-card" data-rule-id="{{ rule.id }}">
      <div class="rule-drag-handle">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
        </svg>
      </div>
      <div class="rule-info">
        <div class="rule-priority">
          <span class="priority-badge">#{{ rule.priority }}</span>
        </div>
        <div class="rule-details">
          <div class="rule-header">
            <div class="rule-name">
              {{ rule.name }}
              <span class="rule-action-badge rule-action-{{ rule.action.lower() }}">{{ rule.action_display }}</span>
            </div>
          </div>
          <div class="rule-meta">
            {% if rule.description %}
            <span class="rule-description">{{ rule.description }}</span>
            <span class="rule-meta-separator">•</span>
            {% endif %}
            {% if rule.host_matches %}
            <span class="rule-match">Host: {{ rule.host_matches }}</span>
            <span class="rule-meta-separator">•</span>
            {% endif %}
            {% if rule.port_matches %}
            <span class="rule-match">Port: {{ rule.port_matches }}</span>
            <span class="rule-meta-separator">•</span>
            {% endif %}
            {% if rule.protocol_matches %}
            <span class="rule-match">{{ rule.protocol_matches|upper }}</span>
            <span class="rule-meta-separator">•</span>
            {% endif %}
            {% if rule.action == 'FORWARD' and rule.forward_host %}
            <span class="rule-forward">→ {{ rule.forward_host }}:{{ rule.forward_port }}</span>
            <span class="rule-meta-separator">•</span>
            {% endif %}
            <span class="rule-created">Created <span class="ts" data-timestamp="{{ rule.created_at.isoformat() }}" data-format="date">{{ rule.created_at.strftime('%b %d, %Y') }}</span></span>
          </div>
        </div>
      </div>
      <div class="rule-actions">
        <a href="/dashboard/proxy/rule/{{ rule.id }}" class="action-btn edit-btn">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <span>Edit</span>
        </a>
        <button class="action-btn delete-btn" data-rule-id="{{ rule.id }}">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          <span>Delete</span>
        </button>
      </div>
    </div>
    {% endfor %}

    {% if not rules %}
    <div class="empty-state">
      <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <rect x="2" y="2" width="20" height="8" rx="1" stroke-width="1.5"/>
        <rect x="2" y="14" width="20" height="8" rx="1" stroke-width="1.5"/>
        <circle cx="5" cy="6" r="1" fill="currentColor"/>
        <circle cx="5" cy="18" r="1" fill="currentColor"/>
        <line x1="8" y1="6" x2="11" y2="6" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="8" y1="18" x2="11" y2="18" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="14" y1="6" x2="19" y2="6" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="14" y1="18" x2="19" y2="18" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M12 10.5 L12 13.5" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M10.5 12 L13.5 12" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <h3 class="empty-state-title">No proxy rules yet</h3>
      <p class="empty-state-text">Create your first proxy rule to start routing traffic</p>
      <a href="/dashboard/proxy/rule/new" class="btn btn-sm">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Create Rule
      </a>
    </div>
    {% endif %}
  </div>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h2 class="modal-title">Confirm Deletion</h2>
      <button class="modal-close" id="closeDeleteModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="text-text-secondary">Are you sure you want to delete this rule? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelDeleteModal">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<script src="{{ url_for('static', path='/js/lib/sortable.js') }}"></script>

<script>
  let currentRuleId = null;

  const rulesList = document.getElementById('rulesList');
  if (rulesList) {
    const sortable = Sortable.create(rulesList, {
      handle: '.rule-drag-handle',
      animation: 150,
      ghostClass: 'rule-card-ghost',
      onEnd: async function(evt) {
        const ruleId = evt.item.dataset.ruleId;
        const newIndex = evt.newIndex + 1; // 1-based priority

        try {
          const formData = new FormData();
          formData.append('priority', newIndex);

          const response = await fetch(`/dashboard/proxy/rule/${ruleId}/priority`, {
            method: 'POST',
            body: formData,
          });

          if (response.ok) {
            window.location.reload();
          }
        } catch (error) {
          console.error('Error updating priority:', error);
          evt.item.style.order = evt.oldIndex;
        }
      }
    });
  }
  const isProxyHealthy = "{{ 'true' if is_proxy_healthy else 'false' }}" === 'true';

  document.getElementById('proxyToggle')?.addEventListener('change', async (e) => {
    const isEnabled = e.target.checked;
    const representation = document.querySelector('.proxy-representation');
    const statusText = document.querySelector('.status-text');

    try {
      const formData = new FormData();
      formData.append('enable_proxy', isEnabled);

      const response = await fetch('/dashboard/proxy/status', {
        method: 'POST',
        body: formData,
      });

      if (response.ok) {
        if (isEnabled) {
          representation.classList.remove('proxy-disabled');
          if (!isProxyHealthy) {
            representation.classList.add('proxy-disconnected');
            statusText.textContent = 'Not Connected';
          } else {
            representation.classList.remove('proxy-disconnected');
            statusText.textContent = 'Active';
          }
        } else {
          representation.classList.add('proxy-disabled');
          representation.classList.remove('proxy-disconnected');
          statusText.textContent = 'Disabled';
        }
      } else {
        e.target.checked = !isEnabled;
      }
    } catch (error) {
      console.error('Error toggling proxy:', error);
      e.target.checked = !isEnabled;
    }
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentRuleId = btn.dataset.ruleId;
      document.getElementById('deleteModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });

  function closeModal() {
    document.getElementById('deleteModal').classList.remove('active');
    document.body.style.overflow = '';
    currentRuleId = null;
  }

  document.getElementById('closeDeleteModal')?.addEventListener('click', closeModal);
  document.getElementById('cancelDeleteModal')?.addEventListener('click', closeModal);

  document.getElementById('confirmDeleteBtn')?.addEventListener('click', async () => {
    if (!currentRuleId) return;
    
    try {
      const response = await fetch(`/dashboard/proxy/rule/${currentRuleId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        window.location.reload();
      }
    } catch (error) {
      console.error('Error deleting rule:', error);
    }
  });
</script>
{% endblock %}
