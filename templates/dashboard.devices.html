{% extends "dashboard.layout.html" %}

{% block stylesheets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/devices.css') }}">
{% endblock %}

{% block content %}
<div class="content-card">
  <div class="flex md:items-center justify-between mb-6 flex-col space-y-3 md:flex-row md:space-y-0">
    <div>
      <h1 class="content-title mb-0">Devices</h1>
      <p class="content-subtitle mb-0">Manage connected devices and access tokens</p>
    </div>
    <button id="newDeviceBtn" class="btn btn-sm">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      New Device
    </button>
  </div>

  {% if message %}
  <div class="alert alert-success">{{ message }}</div>
  {% endif %}

  {% if errors %}
  <div class="alert alert-error">
    <ul class="alert-list">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="devices-list">
    {% for d in devices %}
    <div class="device-card">
      <div class="device-info">
        <div class="device-icon device-icon-{{ d.type.lower() }}">
          {% if d.type == 'DESKTOP' %}
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          {% elif d.type == 'APPLE' %}
          <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
          </svg>
          {% elif d.type == 'ANDROID' %}
          <svg class="icon" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.6 9.48l1.84-3.18c.16-.31.04-.69-.26-.85a.637.637 0 00-.83.22l-1.88 3.24a11.46 11.46 0 00-8.94 0L5.65 5.67a.643.643 0 00-.87-.2c-.28.18-.37.54-.22.83L6.4 9.48A10.78 10.78 0 001 18h22a10.78 10.78 0 00-5.4-8.52zM7 15.25a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5zm10 0a1.25 1.25 0 110-2.5 1.25 1.25 0 010 2.5z"/>
          </svg>
          {% elif d.type == 'TV' %}
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect x="2" y="7" width="20" height="13" rx="2" ry="2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="17 2 12 7 7 2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {% else %}
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke-width="2"/>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>
          </svg>
          {% endif %}
        </div>
        <div class="device-details">
          <div class="device-name">
            {{ d.name }}
            <span class="device-type-badge device-type-{{ d.type.lower() }}">{{ d.type_display }}</span>
          </div>
          <div class="device-meta">
            <span class="device-created">Created <span class="ts" data-timestamp="{{ d.created_at.isoformat() }}" data-format="date-long">{{ d.created_at.strftime('%B %d, %Y') }}</span></span>
            {% if d.updated_at > d.created_at %}
            <span class="device-meta-separator">â€¢</span>
            <span class="device-updated">Updated <span class="ts" data-timestamp="{{ d.updated_at.isoformat() }}" data-format="date-long">{{ d.updated_at.strftime('%B %d, %Y') }}</span></span>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="device-actions">
        <button class="action-btn edit-btn" data-device-id="{{ d.id }}">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <span>Edit</span>
        </button>
        <button class="action-btn token-btn" data-device-id="{{ d.id }}" data-token="{{ d.token }}">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
          </svg>
          <span>Token</span>
        </button>
        <button class="action-btn delete-btn" data-device-id="{{ d.id }}">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          <span>Delete</span>
        </button>
      </div>
    </div>
    {% endfor %}

    {% if not devices %}
    <div class="empty-state">
      <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
      <h3 class="empty-state-title">No devices yet</h3>
      <p class="empty-state-text">Create your first device to get started</p>
      <button class="btn btn-sm" onclick="document.getElementById('newDeviceBtn').click()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Create Device
      </button>
    </div>
    {% endif %}
  </div>
</div>

<div id="deviceModal" class="modal {% if display_modal %}active{% endif %}">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">{{ 'Edit Device' if modal_device and modal_device.id else 'New Device' }}</h2>
      <button class="modal-close" id="closeDeviceModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form id="deviceForm" method="POST" action="{{ '/dashboard/devices/' + (modal_device.id|string if modal_device and modal_device.id else 'new') }}">
      <div class="modal-body">
        {% if modal_errors %}
        <div class="alert alert-error">
          <ul class="alert-list">
            {% for error in modal_errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <div class="form-group">
          <label class="form-label" for="name">Device Name</label>
          <input type="text" id="name" name="name" class="form-input" value="{{ modal_device.name if modal_device else '' }}" placeholder="e.g., John's iPhone, Office Desktop" required maxlength="255">
          <span class="form-help-text">A friendly name to identify this device</span>
        </div>

        <div class="form-group">
          <label class="form-label" for="type">Device Type</label>
          <select id="type" name="type" class="form-input" required>
            <option value="">Select a type...</option>
            {% for device_type in device_types %}
            <option value="{{ device_type }}" {% if modal_device and modal_device.type == device_type %}selected{% endif %}>
              {{ device_type.title() }}
            </option>
            {% endfor %}
          </select>
          <span class="form-help-text">Select the type of device</span>
        </div>

        {% if modal_device and modal_device.token %}
        <div class="form-group">
          <label class="form-label">Access Token</label>
          <div class="token-display">
            <code id="deviceToken" class="token-code">{{ modal_device.token }}</code>
            <button type="button" class="btn btn-sm" id="copyTokenBtn">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              Copy
            </button>
          </div>
          <span class="form-help-text">Use this token to authenticate the device</span>
        </div>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelDeviceModal">Cancel</button>
        <button type="submit" class="btn">{{ 'Save Changes' if modal_device and modal_device.id else 'Create Device' }}</button>
      </div>
    </form>
  </div>
</div>

<div id="tokenModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Device Access Token</h2>
      <button class="modal-close" id="closeTokenModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="text-text-secondary mb-4">Use this token to authenticate the device:</p>
      
      <div class="form-group">
        <label class="form-label">Device Token</label>
        <div class="token-display">
          <code id="tokenModalCode" class="token-code"></code>
          <button type="button" class="btn btn-sm" id="copyTokenModalBtn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Copy
          </button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">PAC URL</label>
        <div class="token-display">
          <code id="pacUrlCode" class="token-code"></code>
          <button type="button" class="btn btn-sm" id="copyPacUrlBtn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Copy
          </button>
        </div>
        <span class="form-help-text">Configure your device to use this URL for automatic proxy configuration</span>
      </div>
      
      <div class="alert alert-info mt-4">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Keep this token secure. Anyone with access to it can use the service on behalf of your device.</span>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" id="closeTokenModalBtn">Done</button>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h2 class="modal-title">Confirm Deletion</h2>
      <button class="modal-close" id="closeDeleteModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="text-text-secondary">Are you sure you want to delete this device? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelDeleteModal">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<script>
  let currentDeviceId = null;

  document.getElementById('newDeviceBtn')?.addEventListener('click', () => {
    window.location.href = '/dashboard/devices/new';
  });

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const deviceId = btn.dataset.deviceId;
      window.location.href = `/dashboard/devices/${deviceId}`;
    });
  });

  document.querySelectorAll('.token-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const token = btn.dataset.token;
      const baseUrl = window.location.origin;
      const pacUrl = `${baseUrl}/pac?device_token=${token}`;
      
      document.getElementById('tokenModalCode').textContent = token;
      document.getElementById('pacUrlCode').textContent = pacUrl;
      document.getElementById('tokenModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentDeviceId = btn.dataset.deviceId;
      document.getElementById('deleteModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
    currentDeviceId = null;
    setTimeout(() => {
      if (modalId === 'deviceModal') {
        window.location.href = '/dashboard/devices';
      }
    }, 250);
  }

  document.getElementById('closeDeviceModal')?.addEventListener('click', () => closeModal('deviceModal'));
  document.getElementById('cancelDeviceModal')?.addEventListener('click', () => {
    window.location.href = '/dashboard/devices';
  });

  document.getElementById('closeTokenModal')?.addEventListener('click', () => closeModal('tokenModal'));
  document.getElementById('closeTokenModalBtn')?.addEventListener('click', () => closeModal('tokenModal'));

  document.getElementById('closeDeleteModal')?.addEventListener('click', () => closeModal('deleteModal'));
  document.getElementById('cancelDeleteModal')?.addEventListener('click', () => closeModal('deleteModal'));

  document.getElementById('confirmDeleteBtn')?.addEventListener('click', () => {
    if (!currentDeviceId) return;
    
    fetch(`/dashboard/devices/${currentDeviceId}`, {
      method: 'DELETE',
    }).then(response => {
      if (response.ok) {
        window.location.href = '/dashboard/devices';
      }
    });
  });

  document.getElementById('copyTokenBtn')?.addEventListener('click', () => {
    const token = document.getElementById('deviceToken').textContent;
    navigator.clipboard.writeText(token).then(() => {
      const btn = document.getElementById('copyTokenBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  });

  document.getElementById('copyTokenModalBtn')?.addEventListener('click', () => {
    const token = document.getElementById('tokenModalCode').textContent;
    navigator.clipboard.writeText(token).then(() => {
      const btn = document.getElementById('copyTokenModalBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  });

  document.getElementById('copyPacUrlBtn')?.addEventListener('click', () => {
    const pacUrl = document.getElementById('pacUrlCode').textContent;
    navigator.clipboard.writeText(pacUrl).then(() => {
      const btn = document.getElementById('copyPacUrlBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  });
</script>

{% endblock %}
