{% extends "dashboard.layout.html" %}

{% block stylesheets %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', path='/css/pages/users.css') }}">
{% endblock %}

{% block content %}
<div class="content-card">
  <div class="flex md:items-center justify-between mb-6 flex-col space-y-3 md:flex-row md:space-y-0">
    <div>
      <h1 class="content-title mb-0">Users</h1>
      <p class="content-subtitle mb-0">Manage user accounts and permissions</p>
    </div>
    <button id="newUserBtn" class="btn btn-sm">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      New User
    </button>
  </div>

  {% if message %}
  <div class="alert alert-success">{{ message }}</div>
  {% endif %}

  {% if errors %}
  <div class="alert alert-error">
    <ul class="alert-list">
      {% for error in errors %}
      <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="users-list">
    {% for u in users %}
    <div class="user-card {% if u.id == user.id %}current-user{% endif %}">
      <div class="user-info">
        <div class="user-avatar">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        <div class="user-details">
          <div class="user-username">
            {{ u.username }}
            {% if u.id == user.id %}
            <span class="user-badge">You</span>
            {% endif %}
          </div>
          <div class="user-created">Created <span class="ts" data-timestamp="{{ u.created_at.isoformat() }}" data-format="date-long">{{ u.created_at.strftime('%B %d, %Y') }}</span></div>
        </div>
      </div>
      <div class="user-actions">
        <button class="action-btn edit-btn" data-user-id="{{ u.id }}">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          <span>Edit</span>
        </button>
        <button class="action-btn two-fa-btn {% if u.totp_enabled %}enabled{% endif %}" data-user-id="{{ u.id }}" data-2fa-enabled="{{ u.totp_enabled }}">
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          <span>2FA</span>
        </button>
        <button class="action-btn delete-btn" data-user-id="{{ u.id }}" {% if u.id == user.id %}disabled{% endif %}>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          <span>Delete</span>
        </button>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<div id="userModal" class="modal {% if display_modal and not totp_secret %}active{% endif %}">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">{{ 'Edit User' if modal_user else 'New User' }}</h2>
      <button class="modal-close" id="closeUserModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form id="userForm" method="POST" action="{{ '/dashboard/users/' + (modal_user.id|string if modal_user else 'new') }}">
      <div class="modal-body">
        {% if modal_errors %}
        <div class="alert alert-error">
          <ul class="alert-list">
            {% for error in modal_errors %}
            <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <div class="form-group">
          <label class="form-label" for="username">Username</label>
          <input type="text" id="username" name="username" class="form-input" value="{{ modal_user.username if modal_user else '' }}" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Password</label>
          <input type="password" id="password" name="password" class="form-input" {% if not modal_user %}required{% endif %}>
          {% if modal_user %}
          <span class="form-help-text">Leave empty to keep current password</span>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelUserModal">Cancel</button>
        <button type="submit" class="btn">{{ 'Save Changes' if modal_user else 'Create User' }}</button>
      </div>
    </form>
  </div>
</div>

<div id="twoFACodeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Disable 2FA</h2>
      <button class="modal-close" id="close2FACodeModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <form id="twoFACodeForm" method="POST">
      <div class="modal-body">
        <p class="text-text-secondary mb-4">Enter the 6-digit code from your authenticator app to disable 2FA.</p>
        
        <div class="code-input-container">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
          <input type="text" class="code-input" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
        </div>
        <input type="hidden" name="code" id="twoFACode">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancel2FACodeModal">Cancel</button>
        <button type="submit" class="btn">Disable 2FA</button>
      </div>
    </form>
  </div>
</div>

<div id="twoFAQRModal" class="modal {% if totp_secret %}active{% endif %}">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">2FA Enabled</h2>
      <button class="modal-close" id="close2FAQRModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="text-text-secondary mb-4">Scan this QR code with your authenticator app:</p>
      
      <div id="qrcodeContainer" class="qrcode-container"></div>
      
      <div class="secret-container">
        <label class="form-label">Or enter this key manually:</label>
        <div class="secret-display">
          <code id="secretKey">{{ totp_secret if totp_secret else '' }}</code>
          <button type="button" class="btn btn-sm" id="copySecretBtn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Copy
          </button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn" id="close2FAQRModalBtn">Done</button>
    </div>
  </div>
</div>

<div id="deleteModal" class="modal">
  <div class="modal-content modal-sm">
    <div class="modal-header">
      <h2 class="modal-title">Confirm Deletion</h2>
      <button class="modal-close" id="closeDeleteModal">
        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <p class="text-text-secondary">Are you sure you want to delete this user? This action cannot be undone.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" id="cancelDeleteModal">Cancel</button>
      <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
    </div>
  </div>
</div>

<script>
  let currentUserId = null;

  document.getElementById('newUserBtn')?.addEventListener('click', () => {
    window.location.href = '/dashboard/users/new';
  });

  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const userId = btn.dataset.userId;
      window.location.href = `/dashboard/users/${userId}`;
    });
  });

  document.querySelectorAll('.two-fa-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const userId = btn.dataset.userId;
      const isEnabled = btn.dataset['2faEnabled'] === 'True';
      
      if (isEnabled) {
        currentUserId = userId;
        document.getElementById('twoFACodeModal').classList.add('active');
        document.body.style.overflow = 'hidden';
        document.querySelector('.code-input').focus();
      } else {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/dashboard/users/${userId}/2fa`;
        document.body.appendChild(form);
        form.submit();
      }
    });
  });

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.disabled) return;
      currentUserId = btn.dataset.userId;
      document.getElementById('deleteModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    });
  });

  function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
    currentUserId = null;
    setTimeout(() => {
      if (modalId === 'userModal' || modalId === 'twoFAQRModal') {
        window.location.href = '/dashboard/users';
      }
    }, 250);
  }

  document.getElementById('closeUserModal')?.addEventListener('click', () => closeModal('userModal'));
  document.getElementById('cancelUserModal')?.addEventListener('click', () => {
    window.location.href = '/dashboard/users';
  });

  document.getElementById('close2FACodeModal')?.addEventListener('click', () => closeModal('twoFACodeModal'));
  document.getElementById('cancel2FACodeModal')?.addEventListener('click', () => closeModal('twoFACodeModal'));

  document.getElementById('close2FAQRModal')?.addEventListener('click', () => {
    window.location.href = '/dashboard/users';
  });
  document.getElementById('close2FAQRModalBtn')?.addEventListener('click', () => {
    window.location.href = '/dashboard/users';
  });

  document.getElementById('closeDeleteModal')?.addEventListener('click', () => closeModal('deleteModal'));
  document.getElementById('cancelDeleteModal')?.addEventListener('click', () => closeModal('deleteModal'));

  document.getElementById('confirmDeleteBtn')?.addEventListener('click', () => {
    if (!currentUserId) return;
    
    fetch(`/dashboard/users/${currentUserId}`, {
      method: 'DELETE',
    }).then(response => {
      if (response.ok) {
        window.location.href = '/dashboard/users';
      }
    });
  });

  const codeInputs = document.querySelectorAll('.code-input');
  codeInputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      if (e.target.value.length === 1) {
        if (index < codeInputs.length - 1) {
          codeInputs[index + 1].focus();
        }
      }
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        codeInputs[index - 1].focus();
      }
    });

    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
      pastedData.split('').forEach((char, i) => {
        if (index + i < codeInputs.length) {
          codeInputs[index + i].value = char;
        }
      });
      if (index + pastedData.length < codeInputs.length) {
        codeInputs[index + pastedData.length].focus();
      }
    });
  });

  document.getElementById('twoFACodeForm')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const code = Array.from(codeInputs).map(input => input.value).join('');
    document.getElementById('twoFACode').value = code;
    
    const form = e.target;
    form.action = `/dashboard/users/${currentUserId}/2fa`;
    
    const codeInput = document.createElement('input');
    codeInput.type = 'hidden';
    codeInput.name = 'code';
    codeInput.value = code;
    form.appendChild(codeInput);
    
    form.submit();
  });

  document.getElementById('copySecretBtn')?.addEventListener('click', () => {
    const secret = document.getElementById('secretKey').textContent;
    navigator.clipboard.writeText(secret).then(() => {
      const btn = document.getElementById('copySecretBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied';
      setTimeout(() => {
        btn.innerHTML = originalText;
      }, 2000);
    });
  });
</script>

{% if totp_secret %}
<script type="module">
  import QrCode from "/static/js/lib/qrcode.js";

  (function() {
    const secret = '{{ totp_secret }}';
    const username = '{{ user.username }}';
    const issuer = 'Proxyko';
    const otpauthUrl = `otpauth://totp/${issuer}:${username}?secret=${secret}&issuer=${issuer}`;
    
    const matrix = QrCode.generate(otpauthUrl);

    const svg = QrCode.render('svg', matrix, {
      on: getComputedStyle(document.documentElement).getPropertyValue('--color-text-primary').trim(),
      off: getComputedStyle(document.documentElement).getPropertyValue('--color-bg-secondary').trim(),
    });

    const container = document.getElementById('qrcodeContainer');
    container.innerHTML = svg;
  })();
</script>
{% endif %}

{% endblock %}
